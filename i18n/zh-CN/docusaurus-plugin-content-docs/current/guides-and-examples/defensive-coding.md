---
title: Defensive Coding and Designing for Failure
sidebar_label: Defensive Coding
---

为应用程序引入功能开关和远程配置能带来诸多优势，但也存在一些潜在缺陷。幸运的是，通过[防御性编程](#defensive-coding)和合理的默认值设置策略，大多数问题都可以规避。

除了集成SDK时可采取的措施外，平台架构中还内置了多项[故障设计](#designing-for-failure)理念，确保Flagsmith能提供稳定可靠的服务。

## 防御性编程

### 不要假设Flagsmith API始终返回200状态码

首先声明——我们高度重视[SaaS服务的可用性与稳定性](https://flagsmith.statuspage.io/)。虽然100%的在线率不现实，但实践中存在多种可能导致API请求失败的情况：

- 移动设备用户进入电梯后打开应用
- 酒店WiFi存在异常的DNS配置
- 类似场景下的TLS证书问题
- 用户启用了过于激进的DNS拦截工具

虽然API中断的概率极低，但您必须认识到：无法保证在所有场景下都能获得成功的API响应。

基于此认知，以下规则可帮助您规避相关问题。

### 避免阻塞主线程等待API响应

具体解决方案取决于您使用的SDK类型。默认情况下，客户端SDK不会阻塞主线程，采用异步回调模式设计。

对于服务端SDK，需区分[本地/远程评估模式](/clients/overview.md#server-side-sdks)。本地评估模式下，SDK获取环境数据后会将其缓存在内存中，即使后续无法连接API仍可持续运作。

当完全无法连接API时，SDK会超时并回退到[默认值设置](#rule-2-progressively-enhance-your-application-with-default-flags)。远程评估模式下，您需要根据应用场景选择最佳策略，此时[默认值](#rule-2-progressively-enhance-your-application-with-default-flags)同样能发挥作用。

### 采用渐进增强的默认值策略

最有效的解决方案是为所有功能开关设置合理的默认值。Flagsmith SDK支持为布尔型和文本型开关指定默认值，我们强烈建议将其作为标准实践。

应用程序应能在默认安全模式下运行，仅在成功获取API响应后才根据开关值调整行为。

### 尽可能缓存开关值

我们的JavaScript SDK支持将最新获取的开关值存入浏览器localStorage。当新会话启动时，在等待API响应的过程中会优先使用缓存值。这种机制能有效应对API完全不可达的情况。

## 故障设计

### 边缘API

SDK获取开关值时，会请求我们的[边缘API](/advanced-use/edge-api.md)。该基础设施采用无服务器架构（包括计算层和数据存储层），并部署在八个AWS区域，提供基于延迟的路由和区域级故障转移能力。

这意味着您的应用程序请求将由距离最近的区域提供服务。此外，如果整个AWS区域发生故障，请求将自动路由至次近的区域。

### 缓存与高性能SDK

我们的客户端SDK始终会记住最后已知的开关配置，并在无法连接API时（例如移动设备处于飞行模式）使用这些缓存值。

此外，默认情况下我们的客户端SDK仅在初始化时发起网络请求。后续的开关评估请求将在内存中以毫秒级延迟本地完成。

### 服务端SDK与本地评估模式

若您需要端到端开关评估的亚毫秒级延迟（例如在网站落地页进行多变量测试时），可采用运行于[本地评估模式](/clients/overview.md#2---local-evaluation)的服务端SDK。该模式将完整的开关规则引擎部署在您的服务器基础设施中，实现亚毫秒级延迟的多变量测试，完全消除延迟影响。

### 无需代理服务器

我们的平台不要求您运行任何额外基础设施。客户端请求与API之间不存在中继、代理、缓存或CDN节点。

我们提供可选的[边缘代理](/advanced-use/edge-proxy.md)，但该组件并非强制要求。

### 支持自定义CDN或DNS

由于我们不进行缓存处理，您可自由在架构中添加反向代理。客户常通过此方式增强安全性（例如仅允许认证客户端获取开关），或确保应用程序不向第三方域名发起请求（例如为我们的API配置自有DNS命名空间）。